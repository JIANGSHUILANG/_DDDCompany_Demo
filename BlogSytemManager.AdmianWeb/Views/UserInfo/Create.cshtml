@{
    ViewBag.Title = "Create";
    Layout = "~/Views/Shared/_LayoutblogSystemManager.cshtml";
}
@using BlogSytemManager.DomainObject
<!-- content start -->
<div class="admin-content">

    <div class="am-cf am-padding">
        <div class="am-fl am-cf"><strong class="am-text-primary am-text-lg">用户管理</strong>/ <small>新增</small></div>
    </div>

    <div class="am-tabs am-margin" data-am-tabs>
        <ul class="am-tabs-nav am-nav am-nav-tabs">
            <li class="am-active"><a href="javascript:show('#tab1')">基本信息</a></li>
            <li><a href="javascript:show('#tab2')">权限分配</a></li>
        </ul>
        <div class="am-tabs-bd">

            <div class="am-tab-panel am-fade am-in am-active" id="tab1">
                <form action="/UserInfo/Create" method="post" id="form1" class="am-form">
                    <div class="am-g am-margin-top">
                        <div class="am-u-sm-4 am-u-md-2 am-text-right">
                            管理员昵称
           
                        </div>
                        <div class="am-u-sm-8 am-u-md-4">
                            <input type="text" name="UserName" class="am-input-sm" required>
                        </div>
                        <div class="am-hide-sm-only am-u-md-6">*必填，不可重复</div>
                    </div>

                    <div class="am-g am-margin-top">
                        <div class="am-u-sm-4 am-u-md-2 am-text-right">
                            管理员密码
           
                        </div>
                        <div class="am-u-sm-8 am-u-md-4 am-u-end col-end">
                            <input type="text" name="UserPass" class="am-input-sm" required>
                        </div>
                        <div class="am-hide-sm-only am-u-md-6">*必填，不可重复</div>
                    </div>

                    <div class="am-g am-margin-top">
                        <div class="am-u-sm-4 am-u-md-2 am-text-right">
                            管理员登录邮箱
           
                        </div>
                        <div class="am-u-sm-8 am-u-md-4">
                            <input type="text" name="Email" class="am-input-sm" required>
                        </div>
                        <div class="am-hide-sm-only am-u-md-6">*必填，不可重复</div>
                    </div>

                    <div class="am-g am-margin-top">
                        <div class="am-u-sm-4 am-u-md-2 am-text-right">
                            管理员联系方式
           
                        </div>
                        <div class="am-u-sm-8 am-u-md-4">
                            <input type="number" name="cell" class="am-input-sm">
                        </div>
                        <div class="am-hide-sm-only am-u-md-6">选填</div>
                    </div>

                    <div class="am-g am-margin-top">
                        <div class="am-u-sm-4 am-u-md-2 am-text-right">
                            管理员家庭住址
           
                        </div>
                        <div class="am-u-sm-8 am-u-md-4">
                            <input type="text" name="address" class="am-input-sm">
                        </div>
                        <div class="am-hide-sm-only am-u-md-6">选填</div>
                    </div>

                    <div class="am-g am-margin-top">
                        <div class="am-u-sm-4 am-u-md-2 am-text-right">
                            排序方式
           
                        </div>
                        <div class="am-u-sm-8 am-u-md-4">
                            <input type="text" name="shot" class="am-input-sm">
                        </div>
                        <div class="am-hide-sm-only am-u-md-6">选填</div>
                    </div>

                    <div class="am-g am-margin-top">
                        <div class="am-u-sm-4 am-u-md-2 am-text-right">
                            创建时间
           
                        </div>
                        <div class="am-u-sm-8 am-u-md-4">
                            <input type="datetime" name="RegTime" class="am-input-sm">
                        </div>
                        <div class="am-hide-sm-only am-u-md-6">选填</div>
                    </div>

                    <div class="am-g am-margin-top-sm">
                        <div class="am-u-sm-12 am-u-md-2 am-text-right admin-form-text">
                            管理员信息描述
                        </div>
                        <div class="am-u-sm-12 am-u-md-10">
                            <textarea rows="10" placeholder="请使用富文本编辑插件"></textarea>
                        </div>
                    </div>
                </form>
            </div>

            <div class="am-tab-panel am-fade" id="tab2">
                <form method="post" id="from2" class="am-form">
                    <div class="am-g am-margin-top">
                        <div class="am-u-sm-4 am-u-md-2 am-text-right">分配用户角色</div>
                        <div class="am-u-sm-8 am-u-md-10">
                            <select name="role" data-am-selected="{btnSize: 'sm'}">
                                @{
                                    <option value="0">待选择</option>
                                    if (ViewData["Role"] != null)
                                    {
                                        var templist = (RoleObject[])ViewData["Role"];
                                        foreach (var role in templist)
                                        {
                                    <option value="@role.ID">@role.RoleName</option>
                                        }
                                    }
                                }
                            </select>
                        </div>
                    </div>

                    <br />

                    <div class="am-g am-margin-top">
                        <div class="am-u-sm-4 am-u-md-2 am-text-right">分配可操作方法</div>
                        <div class="am-u-sm-8 am-u-md-10">
                            <select onchange="selectchange('ActionInfo')" id="ActionInfo" class="sss" data-am-selected="{btnSize: 'sm'}">
                                @{
                                    <option value="0">待选择</option>
                                    if (ViewData["ActionInfo"] != null)
                                    {
                                        var templist = (ActionInfoObject[])ViewData["ActionInfo"];
                                        foreach (var action in templist)
                                        {
                                    <option value="@action.ID">@action.Url</option>
                                        }
                                    }
                                }
                            </select>
                            <br />
                            <br />
                            <div id="selectActionInfo">
                            </div>
                            <input name="ActionInfos" type="hidden" />
                        </div>
                    </div>

                    <br />

                    <div class="am-g am-margin-top">
                        <div class="am-u-sm-4 am-u-md-2 am-text-right">设置用户可见菜单</div>
                        <div class="am-u-sm-8 am-u-md-10">
                            <div class="am-btn-group" data-am-button>
                                @{
                                    if (ViewData["Menu"] != null)
                                    {
                                        var templist = (MenuObject[])ViewData["Menu"];
                                        foreach (var item in templist)
                                        {
                                    <label class="am-btn am-btn-default am-btn-xs">
                                        <input type="checkbox" name="menu" value="@item.ID">
                                        @item.MenuName
                                    </label>
                                        }
                                    }
                                }
                            </div>
                        </div>
                    </div>

                    <br />

                    <div class="am-g am-margin-top">
                        <div class="am-u-sm-4 am-u-md-2 am-text-right">允许操作</div>
                        <div class="am-u-sm-8 am-u-md-10">
                            <div class="am-btn-group" data-am-button>
                                @{
                                    if (ViewData["Permission"] != null)
                                    {
                                        var templist = (PermissionObject[])ViewData["Permission"];
                                        foreach (var item in templist)
                                        {
                                    <label class="am-btn am-btn-default am-btn-xs">
                                        <input type="checkbox" name="permission" value="@item.ID">
                                        @item.PermissionName
                                    </label>
                                        }
                                    }
                                }
                            </div>
                        </div>
                    </div>
                </form>
            </div>


        </div>
    </div>
    <input type="hidden" id="userinfo_ID" value=" @(ViewBag.UserInfo_ID == null ? 0 : ViewBag.UserInfo_ID)" />

    <div class="am-margin">
        <button type="button" class="am-btn am-btn-primary am-btn-xs" onclick="uploadcreateuserinfo()">提交保存</button>
        <a type="button" class="am-btn am-btn-primary am-btn-xs" href="javascript:history.go(-1);location.reload();">放弃保存</a>
    </div>
</div>
<!-- content end -->

<script type="text/javascript">
    window.onload = function () {
        //动态绑定  remove   hidden-input  
        $(document).on('click', '.am-close', function () {
            var value = $(this).data("value");
            var text = $(this).data("text");
            var id = $(this).data("id");

            var input = $("input[name=" + id + "s]");
            if (input.val().trim() != "") {
                var arr = [];
                var strs = input.val().split('|');
                var temp = "";
                for (var i = 0; i < strs.length; i++) {
                    if (strs[i] != value) {
                        arr.push(strs[i]);
                    }
                }
                input.val(arr.join('|'));
            }

            var allspantexts = $("#select" + id).find("span");

            for (var i = 0; i < allspantexts.length; i++) {
                if ($(allspantexts[i]).text() == text) {
                    $(allspantexts[i]).remove();
                    $(this).remove();
                }
            }
        })

        var message = '@ViewBag.message';
        if (message.trim() != "") {
            alert(message);
        }
    }

    //提交保存
    function uploadcreateuserinfo() {
        var userinfo_ID = $("#userinfo_ID").val();
        if (userinfo_ID == "0") {
            $("#form1").submit();
        } else {
            var permissions = jointstrs("input[name=permission]:checked"); //允许操作
            var menuns = jointstrs("input[name=menu]:checked"); //用户可见菜单
            var actioninfos = $("input[name=ActionInfos]").val();
            var role = $("select[name=role]").find('option:selected').val();

            var parm = {
                userinfo_ID: userinfo_ID,
                ActionInfos: actioninfos,
                Menu: menuns,
                Permission: permissions,
                role: role
            };
            $.post("/UserInfo/Autor", parm, function () {

            });
        }

    }



    function jointstrs(dom) {
        var tempdom = $(dom);
        var strs = "";
        if (tempdom.length <= 0) return "";
        for (var i = 0; i < tempdom.length; i++) {
            strs += $(tempdom[i]).val() + '|';
        }
        var templength = strs.lastIndexOf('|');
        strs = strs.substr(0, templength);
        return strs;
    }

    function selectchange(id) {
        var selected = $("#" + id).find("option:selected");
        var allspantexts = $("#select" + id).find("span");
        for (var i = 0; i < allspantexts.length; i++) {
            if ($(allspantexts[i]).text() == selected.text()) {
                alert('已选中,不可重复添加 !');
                return;
            }
        }

        var input = $("input[name=" + id + "s]");
        if (input.val().trim() != "") {
            input.val(input.val() + "|" + selected.val());
        } else {
            input.val(selected.val());
        }

        var html = "";
        html += allspantexts.length >= 5 ? "<br/><br/>" : "";
        html += '<span class="am-badge am-badge-success" style="height: 30px;">' + selected.text() + '</span>';
        html += '<button type="button" data-text=' + selected.text() + ' data-value=' + selected.val() + ' data-id=' + id + '  class="am-close">&times;</button>';
        $("#select" + id).append(html);
    }

    function show(tab) {
        window.location.href = tab;
    }
</script>
